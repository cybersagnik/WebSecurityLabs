const express = require('express');
const { handleLogin } = require('./task1');
const handleYourOtp = require('./your-otp');
const { handleVerifyOtpGet, handleVerifyOtpPost } = require('./verify-otp');
const handleProtectedResource = require('./protected-resource');


const router = express.Router();

// Root - Login Form
router.get('/', (req, res) => {
  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Admin Portal</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
          font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
          background: #f4f6f8;
          min-height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          color: #333;
        }

        .container {
          background: #ffffff;
          padding: 32px;
          border-radius: 6px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.08);
          max-width: 380px;
          width: 100%;
        }

        h1 {
          font-size: 20px;
          font-weight: 600;
          margin-bottom: 6px;
          text-align: center;
        }

        .subtitle {
          text-align: center;
          font-size: 13px;
          color: #666;
          margin-bottom: 24px;
        }

        .form-group {
          margin-bottom: 16px;
        }

        label {
          display: block;
          font-size: 13px;
          font-weight: 500;
          margin-bottom: 6px;
          color: #444;
        }

        input {
          width: 100%;
          padding: 10px;
          border: 1px solid #ccc;
          border-radius: 4px;
          font-size: 14px;
        }

        input:focus {
          outline: none;
          border-color: #4c6ef5;
        }

        button {
          width: 100%;
          padding: 10px;
          background: #4c6ef5;
          color: #fff;
          border: none;
          border-radius: 4px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
        }

        button:hover {
          background: #3b5bdb;
        }

        .error {
          margin-top: 12px;
          font-size: 13px;
          color: #c92a2a;
          text-align: center;
        }

        .footer {
          margin-top: 20px;
          font-size: 11px;
          color: #999;
          text-align: center;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <h1>Admin Portal</h1>
        <p class="subtitle">Sign in to continue</p>

        <form onsubmit="handleLogin(event)">
          <div class="form-group">
            <label for="username">Username</label>
            <input id="username" name="username" required />
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required />
          </div>

          <button type="submit">Sign in</button>
          <div id="error" class="error"></div>
        </form>

        <div class="footer">
          Internal access only
        </div>
      </div>

      <script>
        async function handleLogin(event) {
          event.preventDefault();

          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
          const errorDiv = document.getElementById('error');

          try {
            const response = await fetch('/task-1', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, password })
            });

            const data = await response.json();

            if (!response.ok) {
              errorDiv.textContent = data.error || 'Authentication failed';
              return;
            }

            window.location.href = '/your-otp?' + new URLSearchParams({
              otp: data.otp,
              sessionId: data.sessionId
            }).toString();

          } catch (err) {
            errorDiv.textContent = 'Service unavailable';
          }
        }
      </script>
    </body>
    </html>
  `;

  res.send(html);
});


// Mount routes
router.post('/task-1', handleLogin);
router.get('/your-otp', handleYourOtp);
router.get('/verify-otp', handleVerifyOtpGet);
router.post('/verify-otp', handleVerifyOtpPost);

router.get('/protected_resource', handleProtectedResource);

module.exports = router;
