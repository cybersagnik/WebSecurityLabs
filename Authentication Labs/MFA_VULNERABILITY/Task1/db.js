const mongoose = require('mongoose');

// MongoDB Connection
const mongoURL = process.env.MONGO_URL || 'mongodb://localhost:27017/ctf-otp';

mongoose.connect(mongoURL, {
  useNewUrlParser: true,
  useUnifiedTopology: true
}).then(() => {
  console.log('MongoDB connected');
}).catch(err => {
  console.error('MongoDB connection error:', err);
});

// User Schema
const userSchema = new mongoose.Schema({
  username: { type: String, unique: true, required: true },
  password: { type: String, required: true },
  role: { type: String, enum: ['attacker', 'victim'], default: 'victim' }
});

const User = mongoose.model('User', userSchema);

// OTP Session Schema
const otpSessionSchema = new mongoose.Schema({
  username: { type: String, required: true },
  otp: { type: String, required: true },
  sessionId: { type: String, required: true },
  createdAt: { type: Date, default: Date.now, expires: 300 }, // 5 minutes expiry
  verified: { type: Boolean, default: false }
});

const OTPSession = mongoose.model('OTPSession', otpSessionSchema);

// Initialize test users
async function initializeUsers() {
  try {
    const userCount = await User.countDocuments();
    if (userCount === 0) {
      await User.insertMany([
        { username: 'john', password: 'john_otp123', role: 'attacker' },
        { username: 'carlos', password: 'carlos_bypassme', role: 'victim' }
      ]);
      console.log('âœ“ Test users initialized');
    }
  } catch (err) {
    console.error('Error initializing users:', err);
  }
}

initializeUsers();

module.exports = {
  User,
  OTPSession,
  mongoose
};
