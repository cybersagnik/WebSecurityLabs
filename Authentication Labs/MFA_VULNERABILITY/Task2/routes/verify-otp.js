const { OTPSession } = require('../db');

// GET /verify-otp - Display verification form
function handleVerifyOtpGet(req, res) {
  const sessionId = req.cookies?.sessionId;

  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Verify One-Time Password</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
          font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
          background: #f4f6f8;
          min-height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          color: #333;
        }

        .container {
          background: #ffffff;
          padding: 32px;
          border-radius: 6px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.08);
          max-width: 380px;
          width: 100%;
        }

        h1 {
          font-size: 18px;
          font-weight: 600;
          margin-bottom: 6px;
          text-align: center;
        }

        .subtitle {
          text-align: center;
          font-size: 13px;
          color: #666;
          margin-bottom: 24px;
        }

        .form-group {
          margin-bottom: 16px;
        }

        label {
          display: block;
          font-size: 13px;
          font-weight: 500;
          margin-bottom: 6px;
          color: #444;
        }

        input {
          width: 100%;
          padding: 10px;
          border: 1px solid #ccc;
          border-radius: 4px;
          font-size: 16px;
          text-align: center;
          letter-spacing: 3px;
          font-family: monospace;
        }

        input:focus {
          outline: none;
          border-color: #4c6ef5;
        }

        button {
          width: 100%;
          padding: 10px;
          background: #4c6ef5;
          color: #fff;
          border: none;
          border-radius: 4px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
        }

        button:hover {
          background: #3b5bdb;
        }

        .error {
          margin-top: 12px;
          font-size: 13px;
          color: #c92a2a;
          text-align: center;
        }

        .footer {
          margin-top: 20px;
          font-size: 11px;
          color: #999;
          text-align: center;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <h1>Verify One-Time Password</h1>
        <p class="subtitle">
          Enter the verification code sent to your registered device
        </p>

        <form onsubmit="handleVerify(event)">
          <div class="form-group">
            <label for="otpCode">Verification Code</label>
            <input
              type="text"
              id="otpCode"
              name="otpCode"
              maxlength="4"
              pattern="[0-9]{4}"
              placeholder="••••"
              required
            />
          </div>

          <button type="submit">Verify</button>
          <div id="error" class="error"></div>
        </form>

        <div class="footer">
          Session ID: ${sessionId ? sessionId.slice(0, 6) + '…' : 'not set'}
        </div>
      </div>

      <script>
        async function handleVerify(event) {
          event.preventDefault();

          const otpCode = document.getElementById('otpCode').value;
          const errorDiv = document.getElementById('error');

          try {
            const response = await fetch('/verify-otp', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({
                verification_code: otpCode
              })
            });

            const data = await response.json();

            if (!response.ok) {
              errorDiv.textContent = data.error || 'Verification failed';
              return;
            }

            window.location.href = '/protected_resource';

          } catch (err) {
            errorDiv.textContent = 'Service unavailable';
          }
        }
      </script>
    </body>
    </html>
  `;

  res.send(html);
}


// POST /verify-otp - Verify OTP (VULNERABLE)
async function handleVerifyOtpPost(req, res) {
  try {
    const { verification_code } = req.body;
    const sessionId = req.cookies?.sessionId;

    if (!sessionId || !verification_code) {
      return res.status(400).json({ error: 'OTP and session required' });
    }

    const otpSession = await OTPSession.findOne({
      sessionId,
      verified: false,
    });

    if (!otpSession) {
      return res.status(401).json({
        error: 'OTP session invalid or already verified'
      });
    }

    otpSession.attempts += 1;
    if (otpSession.otp !== verification_code) {
      return res.status(401).json({ error: 'Invalid OTP' });
    }

    otpSession.verified = true;
    await otpSession.save();

    res.json({
      message: 'Verification successful',
      redirect: '/protected_resource'
    });

  } catch (err) {
    console.error('Verification error:', err);
    res.status(500).json({ error: 'Internal server error' });
  }
}


module.exports = { handleVerifyOtpGet, handleVerifyOtpPost };
