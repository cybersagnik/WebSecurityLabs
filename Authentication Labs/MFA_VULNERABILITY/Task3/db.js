const mongoose = require('mongoose');

// MongoDB Connection
const mongoURL = process.env.MONGO_URL || 'mongodb://localhost:27017/ctf-otp';

mongoose.connect(mongoURL, {
  useNewUrlParser: true,
  useUnifiedTopology: true
}).then(() => {
  console.log('MongoDB connected');
}).catch(err => {
  console.error('MongoDB connection error:', err);
});

// User Schema
const userSchema = new mongoose.Schema({
  username: { type: String, unique: true, required: true },
  password: { type: String, required: true },
  email: {type: String, required: true}
});

const User = mongoose.model('User', userSchema);

// OTP Session Schema
const otpSessionSchema = new mongoose.Schema({
  username: String,
  otp: String,
  sessionId: String,
  verified: { 
    //keeps track of whether mfa is completed for the session
    //keeping this flag is not vulnerable in itself as it eases user experience by avoiding repeated mfa prompts
    type: Boolean,
    default: false
  },
  attempts:{
    type: Number,
    default: 0
  },
  createdAt: {
    type: Date,
    default: Date.now
  }
});


const OTPSession = mongoose.model('OTPSession', otpSessionSchema);
const loginAttemptSchema = new mongoose.Schema({
  username: {
    type: String,
    required: true
  },
  ip: {
    type: String
  },
  createdAt: {
    type: Date,
    default: Date.now,
    expires: 60 * 10 // auto-delete after 10 minutes
  }
});
const LoginAttempts = mongoose.model('LoginAttempts', loginAttemptSchema);
async function initializeUsers() {
  try {
    const userCount = await User.countDocuments();
    if (userCount === 0 ) {
      await User.insertMany([
        { username: 'carlos', password: '$2b$10$M2451B38DFhy4K9Hblv7IOaEYnxuMh/ysUXXiIu6shYhuN2XFQlxa', email: 'yourtempemailfortesting' }
      ]);
      console.log('âœ“ Test users initialized');
    }
  } catch (err) {
    console.error('Error initializing users:', err);
  }
}

initializeUsers();

module.exports = {
  User,
  OTPSession,
  LoginAttempts,
  mongoose
};
